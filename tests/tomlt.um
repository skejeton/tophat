/**
 * Toml tests (umka/toml.um)
 */

import ("toml.um"; "std.um")

fn readFileStr(path: str): (bool, str) {
  file := std.fopen(path, "r")
  if file == null {
    return false, ""
  }
  std.fseek(file, 0, std.seekEnd)
  datasiz := std.ftell(file)
  std.fseek(file, 0, std.seekBegin)

  data := make([]char, datasiz+1)
  std.fread(file, data)
  
  return true, data
}

fn expectToEqual(a, b: str) {
	if a != b {
		error(sprintf("'%s' != '%s'", a, b))
	}
	printf("Ok\n")
}

fn main() {
	if ok, input := readFileStr("etc/tomlt0.toml"); ok {
		result := toml.parse(input)
    if error := result.getError(); error != null {
      printf("%s", toml.formatError(error, input))
      return
    }

    printf("%s\n", repr(result))
		expectToEqual(str(result.data["a-_"]), "Dam")
		expectToEqual(str(result.data["1"]), "A\"hh")
		expectToEqual(str(result.data["\"I love you\""]), "too")
    expectToEqual(str(map[str]interface{}(result.data["game"])["fps"]), "60")
    expectToEqual(str(map[str]interface{}(result.data["debug"])["editor"]), "true")
    expectToEqual(str(map[str]interface{}(map[str]interface{}(result.data["debug"])["game"])["player position"]), "false")
	}
}